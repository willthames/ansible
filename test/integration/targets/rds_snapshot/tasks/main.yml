- block:
  - name: create DB
    rds:
      db_engine: MySQL
      engine_version: 5.7.17
      instance_name: "{{ resource_prefix }}-snapshot-test-db"
      instance_type: db.t2.micro
      command: create
      wait: yes
      wait_timeout: 600
      size: 5
      username: dbuser
      password: dbuser123
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      region: "{{ aws_region }}"
    register: rds_create

  - name: take snapshot of DB
    rds_snapshot:
      instance_name: "{{ resource_prefix }}-snapshot-test-db"
      snapshot: "{{ resource_prefix }}-snapshot-test-db-snapshot"
      wait: yes
      wait_timeout: 600
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      region: "{{ aws_region }}"

  always:
    - name: destroy DB
      rds:
        instance_name: "{{ resource_prefix }}-snapshot-test-db"
        command: delete
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
        region: "{{ aws_region }}"

    - name: destroy snapshot
      rds_snapshot:
        snapshot: "{{ resource_prefix }}-snapshot-test-db-snapshot"
        state: absent
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
        region: "{{ aws_region }}"
